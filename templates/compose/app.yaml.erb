version: "3.8"

services:
  indexer: &ortelius-app
    image: "avaplatform/ortelius:v1.7.5"
    command: ["stream", "indexer", "-c", "/opt/config.json"]
    external_links:
      - <%= @config['database']['host'] %>
    depends_on:
      - <%= @config['database']['host'] %>
      - migrate
    volumes:
      - avalanche-ipcs:/tmp
      - ../config/ortelius/config.json:/opt/config.json
    restart: on-failure

  avalanche:
    image: "avaplatform/avalanchego:v1.7.5"
    restart: always
    depends_on:
      - indexer
    ports:
      - "9650:9650"
    volumes:
      - ../data/avalanche:/var/lib/avalanche
      - ../config/avalanche/config.json:/opt/config.json
      - ../config/avalanche/chain:/opt/avalanchego
      - avalanche-ipcs:/tmp
    command: /bin/sh -cx "exec /avalanchego/build/avalanchego --config-file=/opt/config.json --network-id=1"

  api:
    <<: *ortelius-app
    command: ["api", "-c", "/opt/config.json"]
    ports:
      - 8080:8080

volumes:
  avalanche-ipcs:
